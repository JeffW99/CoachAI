<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="image/badminton.ico"/>
    <link rel="bookmark" href="image/badminton.ico"/>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>CoachAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.5.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <link rel="stylesheet"  href="css/text.css">

    <script type="text/javascript">
        function change_set(){
            new_set = document.getElementById("set").value;
            $('#rally option').remove();
            change_rally();
        }

        function change_rally(){
            var set=document.getElementById("set").value;
            if(!set){
                set = 1;
            }
            //delete old button
            $('#next').remove();
            $('#back').remove();
            $('#canvas').remove();
            get_interval_rally(set);
            init_tracjectory(set);
        }

        function get_interval_set(){
            game_name = '_2019亞錦賽-周天成VS石宇奇';
            filename = 'statistics/rally_detail_real' + game_name + '.json';
        
            $.getJSON(filename, function(data) {
                //find maximum set
                maximum = Math.max.apply(Math, data.map(function(d) { 
                    return d.set; 
                }));
        
                for(var i=1;i<=maximum;i+=1)
                {
                    var insertText = '<option value='+i+'>'+i+'</option>';
                    $('#set').append(insertText); 
                }
            });
        }

        function get_interval_rally(set){
            game_name = '_2019亞錦賽-周天成VS石宇奇';
            filename = 'statistics/rally_detail_real' + game_name + '.json';
            $.getJSON(filename, function(data) {
                //init set
                if (!set){
                    set = 1;
                }
                //filter data to specific set
                data = data.filter(function(item) {
                    return item.set == set
                });
                data = data[0].info;
                var maximum;
                maximum = Math.max.apply(Math, data.map(function(d) { 
                    return d.rally; 
                }));
                
                for(var i=1;i<=maximum;i+=1)
                {
                    var insertText = '<option value='+i+'>'+i+'</option>';
                    $('#rally').append(insertText); 
                } 
            })
        }

        function init_tracjectory(set){
            $('.ball_tracjectory').html('<div class="row">\
                                        <button class="btn" id="next" type="button">下一球</button>\
                                        <button class="btn" id="back" type="button">上一球</button>\
                                        </div>\
                                        <canvas id="canvas" width="1200" height="600"></canvas>');
            var rally = document.getElementById("rally").value;
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var i=0;
            ctx.clearRect(100,100,935,424);
            game_name = '_2019亞錦賽-周天成VS石宇奇';
            filename = 'statistics/rally_detail_real' + game_name + '.json';

            $.getJSON(filename, function(data) {
                if(!set){
                    set = 1;
                }
                if(!rally){
                    rally = 1;
                }
        
                //filter data to specific set
                data = data.filter(function(item) {
                    return item.set == set
                });
                data = data[0].info;
                //filter data to specific rally
                data = data.filter(function(item) {
                    return parseInt(item.rally) == rally;
                });
                data = data[0].result;
                console.log(data);
                var maxorder = Math.max.apply(Math, data.map(function(d) { 
                    return d.order; 
                }));
        
                function initial() {
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.strokeStyle = "black";
                    //球場外框
                    ctx.rect(100,100,935,424);
                    //直的線
                    ctx.moveTo(153,100);
                    ctx.lineTo(153,524);
                    ctx.moveTo(290,100);
                    ctx.lineTo(290,524);
                    ctx.moveTo(428,100);
                    ctx.lineTo(428,524);
                    ctx.moveTo(568,100);
                    ctx.lineTo(568,524);
                    ctx.moveTo(708,100);
                    ctx.lineTo(708,524);
                    ctx.moveTo(845,100);
                    ctx.lineTo(845,524);	
                    ctx.moveTo(982,100);
                    ctx.lineTo(982,524);
                    //橫的線
                    ctx.moveTo(100,132);
                    ctx.lineTo(1035,132);
                    ctx.moveTo(100,492);
                    ctx.lineTo(1035,492);
                    ctx.moveTo(100,312);
                    ctx.lineTo(428,312);
                    ctx.moveTo(708,312);
                    ctx.lineTo(1035,312);
                    ctx.closePath();
                    ctx.stroke();
                }
                
                initial();
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(data[0].detail_hit_pos[1]+100,data[0].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                ctx.strokeStyle = "black";
                ctx.closePath();
                ctx.stroke();
                $("#next").click(function(){
                    if(i != maxorder-1){
                        if(i>2) {
                            ctx.beginPath();
                            ctx.clearRect(50,50,985,474);
                            ctx.closePath();
                            ctx.stroke();
                            initial();
                            //faded
                            ctx.lineWidth = 3;
                            for(var j=0;j<i-2;j++) {
                                ctx.beginPath();
                                ctx.arc(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                                ctx.strokeStyle = "rgb(229, 226, 222)";
                                ctx.closePath();
                                ctx.stroke();
                                ctx.beginPath();
                                ctx.moveTo(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100);
                                ctx.lineTo(data[j+1].detail_hit_pos[1]+100,data[j+1].detail_hit_pos[0]+100);
                                ctx.strokeStyle = "rgb(229, 226, 222)";
                                ctx.closePath();
                                ctx.stroke();
                            }
                            //normal
                            for(var j=i-2;j<i+1;j++) {
                                ctx.beginPath();
                                ctx.arc(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                                ctx.strokeStyle = "black";
                                ctx.closePath();
                                ctx.stroke();
                                ctx.beginPath();
                                ctx.moveTo(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100);
                                ctx.lineTo(data[j+1].detail_hit_pos[1]+100,data[j+1].detail_hit_pos[0]+100);
                                if(j==i-2){
                                    ctx.strokeStyle = "rgb(252, 133, 133)";
                                }
                                if(j==i-1){
                                    ctx.strokeStyle = "rgb(173, 34, 34)";
                                }
                                if(j==i){
                                    ctx.strokeStyle = "rgb(91, 0, 0)";
                                }
                                ctx.closePath();
                                ctx.stroke();
                            }
                            ctx.beginPath();
                            ctx.arc(data[i+1].detail_hit_pos[1]+100,data[i+1].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                            ctx.strokeStyle = "black";
                            ctx.closePath();
                            ctx.stroke();
                        }
                        else {
                            ctx.beginPath();
                            ctx.clearRect(50,50,985,474);
                            ctx.closePath();
                            ctx.stroke();
                            initial();
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            ctx.arc(data[0].detail_hit_pos[1]+100,data[0].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                            ctx.strokeStyle = "black";
                            ctx.closePath();
                            ctx.stroke();
                            for(var j=i+1;j>0;j--) {
                                ctx.beginPath();
                                ctx.arc(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                                ctx.strokeStyle = "black";
                                ctx.closePath();
                                ctx.stroke();
                                ctx.beginPath();
                                ctx.moveTo(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100);
                                ctx.lineTo(data[j-1].detail_hit_pos[1]+100,data[j-1].detail_hit_pos[0]+100);
                                if(j==i-1){
                                    ctx.strokeStyle = "rgb(252, 133, 133)";
                                }
                                if(j==i){
                                    ctx.strokeStyle = "rgb(173, 34, 34)";
                                }
                                if(j==i+1){
                                    ctx.strokeStyle = "rgb(91, 0, 0)";
                                }
                                ctx.closePath();
                                ctx.stroke();
                            }
                        }
                        if(i!=maxorder-2) {
                            i+=1;
                        }
                        else{
                            i = maxorder - 1;
                        }
                    }
                    
                });
            
                $("#back").click(function(){
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.clearRect(50,50,985,474);
                    ctx.closePath();
                    ctx.stroke();
                    initial();
                    ctx.lineWidth = 3;
                    if(i>4) {
                        //faded
                        for(var j=0;j<i-4;j++) {
                            ctx.beginPath();
                            ctx.arc(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                            ctx.strokeStyle = "rgb(229, 226, 222)";
                            ctx.closePath();
                            ctx.stroke();
                            ctx.beginPath();
                            ctx.moveTo(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100);
                            ctx.lineTo(data[j+1].detail_hit_pos[1]+100,data[j+1].detail_hit_pos[0]+100);
                            ctx.strokeStyle = "rgb(229, 226, 222)";
                            ctx.closePath();
                            ctx.stroke();
                        }
                        //normal
                        for(var j=i-4;j<i-1;j++) {
                            ctx.beginPath();
                            ctx.arc(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                            ctx.strokeStyle = "black";
                            ctx.closePath();
                            ctx.stroke();
                            ctx.beginPath();
                            ctx.moveTo(data[j+1].detail_hit_pos[1]+100,data[j+1].detail_hit_pos[0]+100);
                            ctx.lineTo(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100);
                            if(j==i-4){
                                ctx.strokeStyle = "rgb(252, 133, 133)";
                            }
                            if(j==i-3){
                                ctx.strokeStyle = "rgb(173, 34, 34)";
                            }
                            if(j==i-2){
                                ctx.strokeStyle = "rgb(91, 0, 0)";
                            }
                            
                            ctx.closePath();
                            ctx.stroke();
                        }
                        ctx.beginPath();
                        ctx.arc(data[i-1].detail_hit_pos[1]+100,data[i-1].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                        ctx.strokeStyle = "black";
                        ctx.closePath();
                        ctx.stroke();
                    }
                    else {
                        ctx.beginPath();
                        //ctx.arc(ball_place[0].hit_y+100,ball_place[0].hit_x+100,5,0,Math.PI*2,true);
                        ctx.arc(data[0].detail_hit_pos[1]+100,data[0].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                        ctx.strokeStyle = "black";
                        ctx.closePath();
                        ctx.stroke();
                        // ctx.beginPath();
                        // //ctx.arc(ball_place[j].hit_y+100,ball_place[j].hit_x+100,5,0,Math.PI*2,true);
                        // ctx.arc(data[i-1].detail_hit_pos[1]+100,data[i-1].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                        // ctx.strokeStyle = "black";
                        // ctx.closePath();
                        // ctx.stroke();
                        for(var j=i-1;j>=1;j--) {
                            ctx.beginPath();
                            //ctx.arc(ball_place[j].hit_y+100,ball_place[j].hit_x+100,5,0,Math.PI*2,true);
                            ctx.arc(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100,5,0,Math.PI*2,true);
                            ctx.strokeStyle = "black";
                            ctx.closePath();
                            ctx.stroke();
                            ctx.beginPath();
                            ctx.moveTo(data[j].detail_hit_pos[1]+100,data[j].detail_hit_pos[0]+100);
                            ctx.lineTo(data[j-1].detail_hit_pos[1]+100,data[j-1].detail_hit_pos[0]+100);
                            if(j==i-3){
                                ctx.strokeStyle = "rgb(252, 133, 133)";
                            }
                            if(j==i-2){
                                ctx.strokeStyle = "rgb(173, 34, 34)";
                            }
                            if(j==i-1){
                                ctx.strokeStyle = "rgb(91, 0, 0)";
                            }
                            ctx.closePath();
                            ctx.stroke();
                        }
                    }
                    if(i!=0) {
                        i-=1;
                    }
                })
            });
        }
    </script>
</head>
<body>
    <div class="navbar">
        <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="./home.html">CoachAI</a>
                </div>
                <ul class="nav navbar-nav">
                <li><a href="./home.html">Home</a></li>
                <li><a href="./realdata.html">Real Data</a></li>
                <li><a href="./ourdata.html">Our Data</a></li>
                <li class="active"><a href="./tracjectory.html">Tracjectory</a></li>
                </ul>
            </div>
        </nav>
    </div>
    <div id="dropdown" class="row form-group form-inline">
        <label for="set">Set:</label>
        <select id="set" class="form-control" onchange=change_set()>
            <script type="text/javascript">get_interval_set();</script>
        </select>
        <label for="rally">Rally:</label>
        <select id="rally" class="form-control">
            <script type="text/javascript">get_interval_rally();</script>
        </select>
        <button id="interval-submit" type="button" class="btn btn-primary" onclick=change_rally()>查詢</button>
    </div>

    <div class="ball_tracjectory">
        <script type="text/javascript">init_tracjectory();</script>
    </div>
</body>
</html>